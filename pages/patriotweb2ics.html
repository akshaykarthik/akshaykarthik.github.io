---
title: Patriotweb2ICS
layout: page
---
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>

<h4>Patriotweb2ICS - by <a href="http://akshaykarthik.com">Akshay Karthik</a></h4>
<div class="message">
    <p>I haven't really been planning on updating it because the code is kind of hacky and I'm basically just creating a raw ICS file by hand. </p>
    <p>If anyone wants to update it, this page is GPL'ed. The source is available at <a href="https://github.com/akshaykarthik/akshaykarthik.github.io/blob/master/pages/patriotweb2ics.html"> my blog's github source </a> (yes, in hindsight it should have been it's own repo but I just threw up a really quick tool at the time so I didn't care).</p>
</div>
<p>This is a simple tool that I wrote for myself to automatically convert the patriotweb course-schedule table into something that google calendar understands.</p>
<hr>
<ol>
    <li>Let's start with where you get the information from patriotweb.</li>
    <li>After you log in to patriotweb, go to "Registration"</li>
    <li>Go into "Student Schedule" and select the appropriate term</li>
    <li>Copy all of the table except first and last rows</li>
</ol>
<form id="inputFromPW" style="margin-bottom: 1em; margin-top: 1em;">
    <label for="inputTable">Paste it into the box below</label>
    <br>
    <textArea style="width: 100%; margin: .5em;" placeholder="Paste your table here" id="inputTable"></textarea>
    <br>
    <input type="submit" value="Process">
</form>
<div id="resultDiv"></div>
<ol start="5">
    <li> Import your calendar into your calendar application of choice:
    <br>
    <a href="https://support.google.com/calendar/answer/37118?hl=en"> Google Calendar </a>
    <br>
    <a href="http://www2.le.ac.uk/offices/itservices/ithelp/my-computer/programs/office/outlook/calendar/icalendar"> Outlook </a>

    <br>
    <a href="http://support.apple.com/en-us/HT202338"> iCalendar </a>
    </li>
</ol>
    <script>
$(document).ready(function(){
    var replaceMap = {
        "M": ["MO", "Monday"],
        "T": ["TU", "Tuesday"],
        "W": ["WE", "Wednesday"],
        "R": ["TH", "Thursday"],
        "F": ["FR", "Friday"],
        "S": ["SA", "Saturday"]
    };

    $("#inputFromPW").submit(function(event){
        var icsOut = ""+
            "BEGIN:VCALENDAR\n" +
            "PRODID:-//akshaykarthik//patriotweb2ics//EN\n" +
            "VERSION:2.0\n" +
            "CALSCALE:GREGORIAN\n" +
            "METHOD:PUBLISH\n";

        var text = $("#inputTable").val();
        var lines = text.split("\n");
        lines.forEach(function(classLine){
            var classLineParts = classLine.split("\t");
            if(classLineParts.length < 12){
            // ignore invalid lines
            // ideally there should be some error handling but w/e
                return;
            }

            // crn doesn't really matter but it provides a good uid for the
            // calendar event
            var crn = classLineParts[0];

            // these 4 are used for the names and descriptions
            // we are ignoring campus, ug/pg marker, and credits 
            var name = classLineParts[1];
            var fullName = classLineParts[2];
            var classLocation = classLineParts[10];
            var professor = classLineParts[11];

            // convert from one to two character segments
            var weekParts = classLineParts[8].split("").map(function(item){
                return replaceMap[item][0];  
            }).join(",");

            var formalWeekParts = classLineParts[8].split("").map(function(item){
                return replaceMap[item][1];  
            });
            // need to be very careful handling dates
            var startDateString = (classLineParts[6]);
            var endDateString = (classLineParts[7]);

            // the replication here should ideally be split up but it personally
            // helps me keep track of everything in my head
            var classTimeSplit = classLineParts[9].split("-");
            var startTime = startDateString + " " + classTimeSplit[0].trim();
            // ics is weird because end-time referes to the end of the first event
            // repeatEndTime refers to the end of the repeating event
            var endTime = startDateString + " " + classTimeSplit[1].trim();
            var repeatEndTime = endDateString + " " + classTimeSplit[1].trim(); 

            var startDateMoment = moment(startTime, "MMM D, YYYY h:mm a");

            // the first day needs to be offset to the first actual day of class
            // what i'm doing is looking for the first day of the week of the class
            // after the start of the semester and setting that as the first day of class 
            var currentMin = startDateMoment.day(formalWeekParts[0]);
            formalWeekParts.forEach(function(weekPart){
                var weekMoment = startDateMoment.day(weekPart);
                if((weekMoment.isAfter(startDateMoment) || weekMoment.isSame(startDateMoment))
                            && weekMoment.isBefore(currentMin)){
                    currentMin = weekMoment;
                }
            });
            startDateMoment = currentMin;

            // this repetition is horrible and should be replaced with a function
            // the problem is that i don't know if it's worth the overhead.
            // TODO: refactor this structure
            var endDateMoment = moment(endTime, "MMM D, YYYY h:mm a");
            var currentMin = endDateMoment.day(formalWeekParts[0]);
            formalWeekParts.forEach(function(weekPart){
                var weekMoment = endDateMoment.day(weekPart);
                if((weekMoment.isAfter(endDateMoment) || weekMoment.isSame(endDateMoment))
                        && weekMoment.isBefore(currentMin)){
                    currentMin = weekMoment;
                    }
            });
            endDateMoment = currentMin;

            var endRepeatMoment = moment(repeatEndTime, "MMM D, YYYY h:mm a");

            var classLine = [
                "BEGIN:VEVENT",
                "UID:" + crn,
                "DTSTART;VALUE=DATE-TIME:" + startDateMoment.format("YYYYMMDD[T]HHmmss"),
                "DTEND;VALUE=DATE-TIME:" + endDateMoment.format("YYYYMMDD[T]HHmmss"),
                "RRULE:FREQ=WEEKLY;UNTIL=" + endRepeatMoment.format("YYYYMMDD[T]HHmmss") +
                    ";BYDAY=" + weekParts, 
                "SUMMARY:" + name,
                "DESCRIPTION:" + name + " - " + fullName + "\\n" + professor,
                "LOCATION:" + classLocation,
                "TRANSP:OPAQUE",
                "END:VEVENT"
                    ].join("\n");
            icsOut += "\n" + classLine;
        });
        icsOut += "\nEND:VCALENDAR";
        //$("#resultDiv").append("<pre><code>"+icsOut+"</code></pre>");
        // alert(JSON.stringify(icsOut));dd

        // returning false stops the page from refreshing.
        window.open("data:text/calendar; charset=utf-8," + encodeURIComponent(icsOut));
            return false;
    }); 
});</script>

